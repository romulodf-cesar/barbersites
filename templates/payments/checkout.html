{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberSites - Checkout</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Django Form Media -->
    {{ usuario_form.media }}
    {{ barbearia_form.media }}

    <style>
        .background-card {
            background-color: #F8F4E3;
        }

        .fixed-top-navbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }

        /* Estilos para validação visual */
        .is-valid {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        
        .form-control:focus.is-valid {
            border-color: #198754;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
        }
        
        .form-control:focus.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .validation-feedback {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .invalid-feedback {
            color: #dc3545;
        }
        
        .valid-feedback {
            color: #198754;
        }
    </style>

</head>

<body class="bg-dark text-white" style="padding-top: 80px;">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary fixed-top-navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home' %}"><img src="{% static '/assets/logo.png' %}" width="150px"></a>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="container-fluid bg-dark py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-white">
                    <span class="text-warning">Finalize sua Compra</span> e Transforme sua Barbearia
                </h1>
                <p class="fs-5 text-secondary">Preencha seus dados para ter acesso aos nossos templates premium.</p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="row justify-content-center">
            <!-- Form Column -->
            <div class="col-lg-6 mb-4">
                <div class="card p-4 shadow-lg bg-body-tertiary" style="border-radius: 15px;">
                    <div class="card-body text-dark">
                        <h5 class="card-title fw-bold mb-4">Informações de Cadastro</h5>
                        <p class="card-text text-secondary mb-4">Preencha seus dados para finalizar a compra</p>

                        <!-- Form -->
                        <form id="checkout-form">
                            {% csrf_token %}

                            <!-- Dados Pessoais -->
                            <h5 class="card-title fw-bold mb-3">Seus Dados Pessoais</h5>
                            <div class="mb-3">
                                {{ usuario_form.nome_completo.label_tag }}
                                {{ usuario_form.nome_completo }}
                                {% if usuario_form.nome_completo.errors %}
                                    <div class="invalid-feedback d-block">{{ usuario_form.nome_completo.errors }}</div>
                                {% endif %}
                                <div class="valid-feedback">Nome válido!</div>
                                <div class="invalid-feedback">Digite seu nome completo (nome e sobrenome).</div>
                            </div>

                            <div class="mb-3">
                                {{ usuario_form.email.label_tag }}
                                {{ usuario_form.email }}
                                {% if usuario_form.email.errors %}
                                    <div class="invalid-feedback d-block">{{ usuario_form.email.errors }}</div>
                                {% endif %}
                                <div class="valid-feedback">Email válido!</div>
                                <div class="invalid-feedback">Digite um email válido (exemplo@dominio.com).</div>
                            </div>

                            <div class="mb-3">
                                {{ usuario_form.telefone.label_tag }}
                                {{ usuario_form.telefone }}
                                {% if usuario_form.telefone.errors %}
                                    <div class="invalid-feedback d-block">{{ usuario_form.telefone.errors }}</div>
                                {% endif %}
                                <div class="valid-feedback">Telefone válido!</div>
                                <div class="invalid-feedback">Digite um telefone válido com DDD (10 ou 11 dígitos).</div>
                                <small class="text-muted">Digite apenas números. Ex: 11987654321</small>
                            </div>

                            <hr class="my-4">

                            <!-- Dados da Barbearia -->
                            <h5 class="card-title fw-bold mb-3">Dados da Barbearia</h5>

                            <div class="mb-3">
                                {{ barbearia_form.nome_barbearia.label_tag }}
                                {{ barbearia_form.nome_barbearia }}
                                {% if barbearia_form.nome_barbearia.errors %}
                                    <div class="invalid-feedback d-block">{{ barbearia_form.nome_barbearia.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                {{ barbearia_form.endereco.label_tag }}
                                {{ barbearia_form.endereco }}
                                {% if barbearia_form.endereco.errors %}
                                    <div class="invalid-feedback d-block">{{ barbearia_form.endereco.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ barbearia_form.cidade.label_tag }}
                                    {{ barbearia_form.cidade }}
                                    {% if barbearia_form.cidade.errors %}
                                        <div class="invalid-feedback d-block">{{ barbearia_form.cidade.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ barbearia_form.estado.label_tag }}
                                    {{ barbearia_form.estado }}
                                    {% if barbearia_form.estado.errors %}
                                        <div class="invalid-feedback d-block">{{ barbearia_form.estado.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-4">
                                {{ barbearia_form.cep.label_tag }}
                                {{ barbearia_form.cep }}
                                {% if barbearia_form.cep.errors %}
                                    <div class="invalid-feedback d-block">{{ barbearia_form.cep.errors }}</div>
                                {% endif %}
                                <div class="valid-feedback">CEP válido!</div>
                                <div class="invalid-feedback">Digite um CEP válido com 8 dígitos.</div>
                                <small class="text-muted">Digite apenas números. Ex: 12345678</small>
                            </div>

                            <!-- Error Messages -->
                            {% if usuario_form.non_field_errors %}
                                <div class="alert alert-danger">{{ usuario_form.non_field_errors }}</div>
                            {% endif %}
                            {% if barbearia_form.non_field_errors %}
                                <div class="alert alert-danger">{{ barbearia_form.non_field_errors }}</div>
                            {% endif %}

                            <hr class="my-4">

                            <!-- Checkboxes -->
                            <div class="form-check mb-3">
                                {{ usuario_form.aceite_termos }}
                                <label class="form-check-label" for="{{ usuario_form.aceite_termos.id_for_label }}">
                                    Aceito os Termos de Uso
                                </label>
                                {% if usuario_form.aceite_termos.errors %}
                                    <div class="invalid-feedback d-block">{{ usuario_form.aceite_termos.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="form-check mb-4">
                                {{ usuario_form.receber_notificacoes }}
                                <label class="form-check-label" for="{{ usuario_form.receber_notificacoes.id_for_label }}">
                                    Desejo receber notificações
                                </label>
                                {% if usuario_form.receber_notificacoes.errors %}
                                    <div class="invalid-feedback d-block">{{ usuario_form.receber_notificacoes.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid mt-5">
                                <button type="submit" id="pay-button" class="btn btn-warning rounded-pill btn-lg fw-bold">
                                    Pagar R${{ plano.valor|floatformat:2 }}
                                </button>

                                <p class="mt-3 text-center">
                                    <a href="/" class="btn btn-secondary rounded-pill w-50">Voltar para a página inicial</a>
                                </p>

                                <p class="text-center text-secondary small mb-0 mt-2">Pagamento seguro via Stripe</p>
                                <p class="text-center text-secondary small">Garantia de 30 dias ou dinheiro de volta</p>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4 mb-4">
                <div class="sticky-top" style="top: 100px;">
                    <!-- Plan Info -->
                    <div class="card p-4 shadow-lg mb-4 bg-body-tertiary">
                        <div class="card-body text-dark">
                            <h5 class="card-title fw-bold mb-4">Informações de Pagamento</h5>
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Plano: {{ plano.nome_plano }}</h5>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <strong>Valor:</strong> R$ {{ plano.valor|floatformat:2 }}<br>
                                        <strong>Descrição:</strong> {{ plano.descricao|default:"Sem descrição." }}
                                    </p>
                                    {% if plano.trial_period_days > 0 %}
                                        <p class="text-success fw-bold mb-0">
                                            Primeiros {{ plano.trial_period_days }} dias grátis!
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Help Card -->
                    <div class="card p-4 shadow-lg" style="background-color: #2b2b2b; border-radius: 15px;">
                        <div class="card-body text-white">
                            <h5 class="card-title fw-bold mb-3">Precisa de Ajuda?</h5>
                            <p class="card-text text-secondary mb-3">Fale conosco via WhatsApp</p>
                            <a href="https://wa.me/seu_numero" target="_blank" class="btn btn-success rounded-pill w-100 fw-bold">
                                Fale Conosco
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-body-tertiary text-center text-lg-start mt-5 py-3 border-top border-secondary">
        <div class="container d-flex justify-content-center justify-content-lg-between align-items-center flex-wrap">
            <div class="text-center text-lg-start mb-2 mb-lg-0">
                <span>© 2025 Barbersites. Todos os direitos reservados.</span>
            </div>
            <div class="d-flex justify-content-center">
                <a href="https://www.facebook.com/" class="mx-2" target="_blank" aria-label="Facebook">
                    <img src="{% static 'assets/facebook.png' %}" alt="Facebook" style="width: 30px; height: 30px;">
                </a>
                <a href="https://www.instagram.com/" class="mx-2" target="_blank" aria-label="Instagram">
                    <img src="{% static 'assets/instagram.png' %}" alt="Instagram" style="width: 30px; height: 30px;">
                </a>
                <a href="https://twitter.com/" class="mx-2" target="_blank" aria-label="Twitter">
                    <img src="{% static 'assets/x.png' %}" alt="Twitter" style="width: 30px; height: 30px;">
                </a>
                <a href="https://wa.me/SEUNUMERO" target="_blank" class="mx-2" aria-label="WhatsApp">
                    <img src="{% static 'assets/whatsapp.png' %}" alt="WhatsApp" style="width: 30px; height: 30px;">
                </a>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>

    <!-- Script de Validação de Formulário -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializa Stripe
            const stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');
            const checkoutForm = document.getElementById('checkout-form');
            const payButton = document.getElementById('pay-button');

            // === FUNÇÕES DE VALIDAÇÃO E MÁSCARA ===

            // Função para permitir apenas números
            function onlyNumbers(event) {
                const key = event.key;
                const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Home', 'End'];
                
                // Permite teclas de controle
                if (allowedKeys.includes(key) || event.ctrlKey || event.metaKey) {
                    return true;
                }
                
                // Impede caracteres não numéricos
                if (!/[0-9]/.test(key)) {
                    event.preventDefault();
                    return false;
                }
                
                return true;
            }

            // Função para aplicar máscara de CEP
            function maskCEP(event) {
                let value = event.target.value.replace(/\D/g, '');
                
                // Limita a 8 dígitos
                if (value.length > 8) {
                    value = value.substring(0, 8);
                }
                
                // Aplica a máscara 99999-999
                if (value.length > 5) {
                    value = value.replace(/(\d{5})(\d{1,3})/, '$1-$2');
                }
                
                event.target.value = value;
            }

            // Função para aplicar máscara de telefone
            function maskTelefone(event) {
                let value = event.target.value.replace(/\D/g, '');
                
                // Limita a 11 dígitos
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Aplica a máscara baseada no comprimento
                if (value.length <= 10) {
                    // Formato: (99)9999-9999
                    if (value.length > 6) {
                        value = value.replace(/(\d{2})(\d{4})(\d{1,4})/, '($1)$2-$3');
                    } else if (value.length > 2) {
                        value = value.replace(/(\d{2})(\d{1,4})/, '($1)$2');
                    } else if (value.length > 0) {
                        value = value.replace(/(\d{1,2})/, '($1');
                    }
                } else {
                    // Formato: (99)99999-9999
                    value = value.replace(/(\d{2})(\d{5})(\d{1,4})/, '($1)$2-$3');
                }
                
                event.target.value = value;
            }

            // Função para validação em tempo real do email
            function validateEmail(event) {
                const email = event.target.value;
                const emailRegex = /^[a-zA-Z0-9]([a-zA-Z0-9._-]*[a-zA-Z0-9])?@[a-zA-Z0-9]([a-zA-Z0-9.-]*[a-zA-Z0-9])?\.[a-zA-Z]{2,}$/;
                const emailField = event.target;
                
                // Remove classes de validação anteriores
                emailField.classList.remove('is-valid', 'is-invalid');
                
                if (email.length > 0) {
                    if (emailRegex.test(email)) {
                        emailField.classList.add('is-valid');
                    } else {
                        emailField.classList.add('is-invalid');
                    }
                }
            }

            // === APLICAÇÃO DAS VALIDAÇÕES ===

            const cepField = document.getElementById('id_cep');
            const telefoneField = document.getElementById('id_telefone');
            const emailField = document.getElementById('id_email');
            const nomeField = document.getElementById('id_nome_completo');

            // Campo CEP
            if (cepField) {
                cepField.addEventListener('keydown', onlyNumbers);
                cepField.addEventListener('input', function(event) {
                    maskCEP(event);
                    const digits = event.target.value.replace(/\D/g, '');
                    event.target.classList.remove('is-valid', 'is-invalid');
                    
                    if (digits.length > 0) {
                        if (digits.length === 8) {
                            event.target.classList.add('is-valid');
                        } else {
                            event.target.classList.add('is-invalid');
                        }
                    }
                });
                
                // Impede colagem de texto não numérico
                cepField.addEventListener('paste', function(event) {
                    event.preventDefault();
                    const paste = (event.clipboardData || window.clipboardData).getData('text');
                    const numbersOnly = paste.replace(/\D/g, '');
                    if (numbersOnly.length <= 8) {
                        cepField.value = numbersOnly;
                        maskCEP({ target: cepField });
                    }
                });
            }

            // Campo Telefone
            if (telefoneField) {
                telefoneField.addEventListener('keydown', onlyNumbers);
                telefoneField.addEventListener('input', function(event) {
                    maskTelefone(event);
                    const digits = event.target.value.replace(/\D/g, '');
                    event.target.classList.remove('is-valid', 'is-invalid');
                    
                    if (digits.length > 0) {
                        if (digits.length === 10 || digits.length === 11) {
                            event.target.classList.add('is-valid');
                        } else {
                            event.target.classList.add('is-invalid');
                        }
                    }
                });
                
                // Impede colagem de texto não numérico
                telefoneField.addEventListener('paste', function(event) {
                    event.preventDefault();
                    const paste = (event.clipboardData || window.clipboardData).getData('text');
                    const numbersOnly = paste.replace(/\D/g, '');
                    if (numbersOnly.length <= 11) {
                        telefoneField.value = numbersOnly;
                        maskTelefone({ target: telefoneField });
                    }
                });
            }

            // Campo Email
            if (emailField) {
                emailField.addEventListener('input', validateEmail);
                emailField.addEventListener('blur', validateEmail);
            }

            // Validação do nome completo
            if (nomeField) {
                nomeField.addEventListener('input', function(event) {
                    const nome = event.target.value;
                    nomeField.classList.remove('is-valid', 'is-invalid');
                    
                    if (nome.length > 0) {
                        // Verifica se tem pelo menos 2 palavras e apenas letras/espaços
                        const palavras = nome.trim().split(/\s+/);
                        const apenasLetras = /^[a-zA-ZÀ-ÿ\s]+$/.test(nome);
                        
                        if (palavras.length >= 2 && apenasLetras) {
                            nomeField.classList.add('is-valid');
                        } else {
                            nomeField.classList.add('is-invalid');
                        }
                    }
                });
            }

            // === FUNÇÕES ORIGINAIS DO STRIPE ===

            // Função para obter CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Função para validar formulário - VERSÃO MELHORADA
            function validateForm() {
                let isValid = true;
                const errors = [];

                // Validação do nome
                const nome = document.getElementById('id_nome_completo');
                if (nome) {
                    const nomeValue = nome.value.trim();
                    if (!nomeValue) {
                        errors.push('Nome completo é obrigatório');
                        isValid = false;
                    } else if (nomeValue.split(/\s+/).length < 2) {
                        errors.push('Digite seu nome completo (nome e sobrenome)');
                        isValid = false;
                    } else if (!/^[a-zA-ZÀ-ÿ\s]+$/.test(nomeValue)) {
                        errors.push('Nome deve conter apenas letras e espaços');
                        isValid = false;
                    }
                }

                // Validação do email
                const email = document.getElementById('id_email');
                if (email) {
                    const emailValue = email.value.trim();
                    const emailRegex = /^[a-zA-Z0-9]([a-zA-Z0-9._-]*[a-zA-Z0-9])?@[a-zA-Z0-9]([a-zA-Z0-9.-]*[a-zA-Z0-9])?\.[a-zA-Z]{2,}$/;
                    if (!emailValue) {
                        errors.push('Email é obrigatório');
                        isValid = false;
                    } else if (!emailRegex.test(emailValue)) {
                        errors.push('Digite um email válido no formato nome@dominio.com');
                        isValid = false;
                    }
                }

                // Validação do telefone
                const telefone = document.getElementById('id_telefone');
                if (telefone) {
                    const telefoneDigits = telefone.value.replace(/\D/g, '');
                    if (!telefoneDigits) {
                        errors.push('Telefone é obrigatório');
                        isValid = false;
                    } else if (![10, 11].includes(telefoneDigits.length)) {
                        errors.push('Telefone deve ter 10 ou 11 dígitos');
                        isValid = false;
                    } else if (telefoneDigits[0] === '0' || telefoneDigits[0] === '1') {
                        errors.push('DDD inválido. Deve começar com dígito de 2 a 9');
                        isValid = false;
                    }
                }

                // Validação do CEP
                const cep = document.getElementById('id_cep');
                if (cep) {
                    const cepDigits = cep.value.replace(/\D/g, '');
                    if (!cepDigits) {
                        errors.push('CEP é obrigatório');
                        isValid = false;
                    } else if (cepDigits.length !== 8) {
                        errors.push('CEP deve ter exatamente 8 dígitos');
                        isValid = false;
                    }
                }

                // Validação dos outros campos obrigatórios
                const requiredFields = [
                    { id: 'id_nome_barbearia', name: 'Nome da Barbearia' },
                    { id: 'id_endereco', name: 'Endereço' },
                    { id: 'id_cidade', name: 'Cidade' },
                    { id: 'id_estado', name: 'Estado' }
                ];

                for (let field of requiredFields) {
                    const element = document.getElementById(field.id);
                    if (!element || !element.value.trim()) {
                        errors.push(`${field.name} é obrigatório`);
                        isValid = false;
                    }
                }

                // Validação dos termos
                const aceiteTermos = document.getElementById('id_aceite_termos');
                if (aceiteTermos && !aceiteTermos.checked) {
                    errors.push('Você deve aceitar os termos de uso para continuar');
                    isValid = false;
                }

                if (!isValid) {
                    alert('Por favor, corrija os seguintes erros:\n\n• ' + errors.join('\n• '));
                    return false;
                }

                return true;
            }

            // Event listener para o submit do formulário
            checkoutForm.addEventListener('submit', function(event) {
                event.preventDefault();

                // Validar formulário
                if (!validateForm()) {
                    return;
                }

                // Coletar dados do formulário
                const formData = {
                    usuario_data: {
                        nome_completo: document.getElementById('id_nome_completo').value.trim(),
                        email: document.getElementById('id_email').value.trim(),
                        telefone: document.getElementById('id_telefone').value.trim(),
                        aceite_termos: document.getElementById('id_aceite_termos').checked,
                        receber_notificacoes: document.getElementById('id_receber_notificacoes').checked
                    },
                    barbearia_data: {
                        nome_barbearia: document.getElementById('id_nome_barbearia').value.trim(),
                        endereco: document.getElementById('id_endereco').value.trim(),
                        cidade: document.getElementById('id_cidade').value.trim(),
                        estado: document.getElementById('id_estado').value,
                        cep: document.getElementById('id_cep').value.trim()
                    }
                };

                // Desabilitar botão durante processamento
                payButton.disabled = true;
                payButton.textContent = 'Processando...';

                // Fazer requisição para criar sessão de checkout
                fetch(`/payments/create-checkout-session/{{ plano.pk }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || `Erro HTTP: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.id) {
                        // Redirecionar para Stripe Checkout
                        return stripe.redirectToCheckout({ sessionId: data.id });
                    } else {
                        throw new Error('ID da sessão não retornado');
                    }
                })
                .then(result => {
                    if (result && result.error) {
                        throw new Error(result.error.message);
                    }
                })
                .catch(error => {
                    console.error('Erro no checkout:', error);
                    alert('Erro ao processar pagamento: ' + error.message);
                })
                .finally(() => {
                    // Reabilitar botão
                    payButton.disabled = false;
                    payButton.textContent = `Pagar R${{ plano.valor|floatformat:2 }}`;
                });
            });
        });
    </script>
</body>

</html>